name: morning-routine
description: Daily morning repository maintenance and status check
schedule: "09:00"  # Run at 9 AM daily

variables:
  notification_email: ${GHOPS_EMAIL:-dev@example.com}
  slack_webhook: ${SLACK_WEBHOOK:-}

tasks:
  - id: fetch_updates
    type: parallel
    name: Fetch all repository updates
    tasks:
      - type: shell
        command: find . -maxdepth 2 -name .git -type d | while read gitdir; do (cd "${gitdir%/.git}" && git fetch --all --prune); done

  - id: check_status
    type: ghops
    name: Check repository statuses
    command: status
    args: ["--format", "json"]
    parse_output: true
    output_var: repo_statuses
    depends_on: [fetch_updates]

  - id: analyze_results
    type: python
    name: Analyze status results
    code: |
      import json
      repos_behind = []
      repos_uncommitted = []
      repos_unpushed = []

      for status in context.get('repo_statuses', []):
          if status.get('behind', 0) > 0:
              repos_behind.append(status['name'])
          if status.get('uncommitted_changes'):
              repos_uncommitted.append(status['name'])
          if status.get('unpushed_commits'):
              repos_unpushed.append(status['name'])

      context['repos_behind'] = repos_behind
      context['repos_uncommitted'] = repos_uncommitted
      context['repos_unpushed'] = repos_unpushed
      context['total_issues'] = len(repos_behind) + len(repos_uncommitted) + len(repos_unpushed)
    depends_on: [check_status]

  - id: check_dependencies
    type: ghops
    name: Check for outdated dependencies
    command: list
    args: ["--filter", "has_outdated_deps", "--format", "json"]
    parse_output: true
    output_var: outdated_deps
    depends_on: [fetch_updates]

  - id: check_security
    type: parallel
    name: Security vulnerability checks
    tasks:
      - type: shell
        command: npm audit --json || true
        output_var: npm_audit
      - type: shell
        command: pip-audit --format json || true
        output_var: pip_audit
    depends_on: [fetch_updates]

  - id: generate_report
    type: python
    name: Generate morning report
    code: |
      report = []
      report.append("# Morning Repository Report")
      report.append(f"Date: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
      report.append("")

      if context.get('repos_behind'):
          report.append(f"## Repositories Behind Upstream ({len(context['repos_behind'])})")
          for repo in context['repos_behind']:
              report.append(f"- {repo}")
          report.append("")

      if context.get('repos_uncommitted'):
          report.append(f"## Uncommitted Changes ({len(context['repos_uncommitted'])})")
          for repo in context['repos_uncommitted']:
              report.append(f"- {repo}")
          report.append("")

      if context.get('repos_unpushed'):
          report.append(f"## Unpushed Commits ({len(context['repos_unpushed'])})")
          for repo in context['repos_unpushed']:
              report.append(f"- {repo}")
          report.append("")

      context['report'] = '\n'.join(report)

      # Save report to file
      with open(f"morning-report-{datetime.now().strftime('%Y%m%d')}.md", 'w') as f:
          f.write(context['report'])
    depends_on: [analyze_results, check_dependencies, check_security]

  - id: send_notifications
    type: parallel
    name: Send notifications
    tasks:
      - type: shell
        name: Email notification
        command: echo "${report}" | mail -s "Morning Repository Report" ${notification_email}
        condition: total_issues > 0
        ignore_errors: true
      - type: shell
        name: Slack notification
        command: |
          curl -X POST ${slack_webhook} -H 'Content-Type: application/json' \
            -d '{"text": "Morning report: ${total_issues} repositories need attention"}'
        condition: slack_webhook != ""
        ignore_errors: true
    depends_on: [generate_report]

on_failure: continue  # Continue even if some tasks fail
timeout: 300  # 5 minute timeout for entire workflow