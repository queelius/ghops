name: release-pipeline
description: Automated release workflow for software projects
variables:
  version: ${VERSION}
  repo_path: ${REPO_PATH:-.}
  branch: ${BRANCH:-main}
  registry: ${REGISTRY:-pypi}  # pypi, npm, both

tasks:
  - id: pre_checks
    type: parallel
    name: Pre-release validation checks
    tasks:
      - id: check_branch
        type: shell
        command: |
          current_branch=$(git branch --show-current)
          if [ "$current_branch" != "${branch}" ]; then
            echo "Error: Not on ${branch} branch (current: $current_branch)"
            exit 1
          fi
        cwd: ${repo_path}

      - id: check_clean
        type: shell
        command: |
          if ! git diff-index --quiet HEAD --; then
            echo "Error: Working directory has uncommitted changes"
            exit 1
          fi
        cwd: ${repo_path}

      - id: check_remote
        type: shell
        command: git fetch origin && git status -uno | grep -q "Your branch is up to date"
        cwd: ${repo_path}

  - id: run_tests
    type: parallel
    name: Run all test suites
    tasks:
      - id: unit_tests
        type: shell
        command: npm test || pytest || go test ./... || cargo test
        cwd: ${repo_path}

      - id: integration_tests
        type: shell
        command: npm run test:integration || pytest tests/integration || true
        cwd: ${repo_path}
        ignore_errors: true

      - id: lint_check
        type: shell
        command: npm run lint || flake8 . || golint ./... || cargo clippy
        cwd: ${repo_path}
    depends_on: [pre_checks]

  - id: build_project
    type: shell
    name: Build project artifacts
    command: |
      if [ -f package.json ]; then
        npm run build
      elif [ -f setup.py ] || [ -f pyproject.toml ]; then
        python -m build
      elif [ -f go.mod ]; then
        go build -v ./...
      elif [ -f Cargo.toml ]; then
        cargo build --release
      fi
    cwd: ${repo_path}
    depends_on: [run_tests]

  - id: update_version
    type: shell
    name: Update version in project files
    command: |
      if [ -f package.json ]; then
        npm version ${version} --no-git-tag-version
      elif [ -f pyproject.toml ]; then
        sed -i "s/version = \".*\"/version = \"${version}\"/" pyproject.toml
      elif [ -f setup.py ]; then
        sed -i "s/version='.*'/version='${version}'/" setup.py
      fi
    cwd: ${repo_path}
    depends_on: [build_project]

  - id: update_changelog
    type: shell
    name: Update CHANGELOG
    command: |
      if [ -f CHANGELOG.md ]; then
        echo -e "## [${version}] - $(date +%Y-%m-%d)\n\n### Added\n- Release ${version}\n\n$(cat CHANGELOG.md)" > CHANGELOG.md
      else
        echo "# Changelog\n\n## [${version}] - $(date +%Y-%m-%d)\n\n- Initial release" > CHANGELOG.md
      fi
    cwd: ${repo_path}
    depends_on: [update_version]

  - id: commit_changes
    type: shell
    name: Commit version changes
    command: |
      git add -A
      git commit -m "Release version ${version}" || true
    cwd: ${repo_path}
    depends_on: [update_changelog]

  - id: create_tag
    type: shell
    name: Create git tag
    command: git tag -a "v${version}" -m "Release version ${version}"
    cwd: ${repo_path}
    depends_on: [commit_changes]

  - id: push_changes
    type: parallel
    name: Push to remote repository
    tasks:
      - type: shell
        command: git push origin ${branch}
        cwd: ${repo_path}

      - type: shell
        command: git push origin "v${version}"
        cwd: ${repo_path}
    depends_on: [create_tag]

  - id: create_github_release
    type: shell
    name: Create GitHub release
    command: |
      gh release create "v${version}" \
        --title "Release v${version}" \
        --notes "Release version ${version}" \
        --draft=false \
        --prerelease=false
    cwd: ${repo_path}
    depends_on: [push_changes]
    ignore_errors: true

  - id: publish_packages
    type: parallel
    name: Publish to package registries
    tasks:
      - id: publish_npm
        type: shell
        command: npm publish --access public
        cwd: ${repo_path}
        condition: registry == "npm" || registry == "both"
        ignore_errors: true

      - id: publish_pypi
        type: shell
        command: python -m twine upload dist/*
        cwd: ${repo_path}
        condition: registry == "pypi" || registry == "both"
        ignore_errors: true
    depends_on: [create_github_release]

  - id: update_docs
    type: parallel
    name: Update documentation
    tasks:
      - type: shell
        command: npm run docs:build && npm run docs:deploy
        cwd: ${repo_path}
        ignore_errors: true

      - type: ghops
        command: docs deploy
        args: ["--path", "${repo_path}"]
        ignore_errors: true
    depends_on: [publish_packages]

  - id: announce_release
    type: parallel
    name: Announce release on social media
    tasks:
      - type: ghops
        command: social post
        args:
          - "--message"
          - "ðŸš€ Released version ${version}! Check out the latest updates."
          - "--repo"
          - "${repo_path}"
        ignore_errors: true

      - type: shell
        command: |
          curl -X POST ${DISCORD_WEBHOOK} \
            -H "Content-Type: application/json" \
            -d '{"content": "Released version ${version}!"}'
        condition: DISCORD_WEBHOOK != ""
        ignore_errors: true
    depends_on: [publish_packages]

on_failure: stop  # Stop on any critical failure
timeout: 1800  # 30 minute timeout