name: release-pipeline
description: Automated release pipeline for Python packages
version: "1.0"

# Workflow metadata
metadata:
  author: ghops
  tags: [release, deployment, pypi]
  required_env:
    - GITHUB_TOKEN
    - PYPI_API_TOKEN

# Input parameters
parameters:
  repo_path:
    type: string
    required: true
    description: Path to the repository to release
  version:
    type: string
    required: true
    description: Version number (e.g., 1.2.3)
  release_type:
    type: string
    default: patch
    choices: [major, minor, patch, prerelease]
    description: Type of release

# Global context
context:
  repo: "${repo_path}"
  version: "${version}"
  branch: main
  test_coverage_threshold: 80

# Task definitions
tasks:
  # Stage 1: Pre-flight checks
  - id: validate-repo
    name: Validate repository state
    type: ghops
    command: status
    args: ["${repo}"]
    parse_output: true
    output_var: repo_status

  - id: check-clean
    name: Ensure clean working directory
    type: python
    depends_on: validate-repo
    code: |
      import json
      status = json.loads(context['repo_status'])
      if status['status']['uncommitted_changes']:
        raise Exception("Repository has uncommitted changes")
      if status['status']['unpushed_commits']:
        raise Exception("Repository has unpushed commits")
      context['repo_name'] = status['name']

  - id: check-branch
    name: Verify on release branch
    type: shell
    depends_on: check-clean
    command: |
      cd "${repo}" && \
      current_branch=$(git branch --show-current)
      if [ "$current_branch" != "${branch}" ]; then
        echo "ERROR: Not on ${branch} branch (current: $current_branch)"
        exit 1
      fi

  # Stage 2: Testing
  - id: run-tests
    name: Run test suite
    type: shell
    depends_on: check-branch
    command: |
      cd "${repo}" && \
      python -m pytest --cov --cov-report=json --cov-report=term
    output_var: test_output

  - id: check-coverage
    name: Verify test coverage
    type: python
    depends_on: run-tests
    code: |
      import json
      with open(f"{context['repo']}/coverage.json") as f:
        coverage_data = json.load(f)

      total_coverage = coverage_data['totals']['percent_covered']
      threshold = context['test_coverage_threshold']

      if total_coverage < threshold:
        raise Exception(f"Coverage {total_coverage}% below threshold {threshold}%")

      context['test_coverage'] = total_coverage
      print(f"Test coverage: {total_coverage}%")

  - id: lint-check
    name: Run linting checks
    type: parallel
    depends_on: run-tests
    tasks:
      - type: shell
        name: Run black
        command: cd "${repo}" && black --check .
        ignore_errors: true

      - type: shell
        name: Run flake8
        command: cd "${repo}" && flake8 .
        ignore_errors: true

      - type: shell
        name: Run mypy
        command: cd "${repo}" && mypy .
        ignore_errors: true

  # Stage 3: Version management
  - id: update-version
    name: Update version in code
    type: shell
    depends_on: check-coverage
    command: |
      cd "${repo}" && \
      # Update version in pyproject.toml or setup.py
      if [ -f pyproject.toml ]; then
        sed -i "s/version = \".*\"/version = \"${version}\"/" pyproject.toml
      elif [ -f setup.py ]; then
        sed -i "s/version=['\"].*['\"]/version='${version}'/" setup.py
      fi

      # Update version in __init__.py
      find . -name "__init__.py" -exec grep -l "__version__" {} \; | \
        xargs sed -i "s/__version__ = ['\"].*['\"]/__version__ = '${version}'/"

  - id: update-changelog
    name: Update CHANGELOG
    type: shell
    depends_on: update-version
    command: |
      cd "${repo}" && \
      # Generate changelog entry
      echo "## [${version}] - $(date +%Y-%m-%d)" > .changelog_tmp
      echo "" >> .changelog_tmp

      # Get commits since last tag
      last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
      if [ -n "$last_tag" ]; then
        git log --pretty=format:"- %s" $last_tag..HEAD >> .changelog_tmp
      else
        git log --pretty=format:"- %s" >> .changelog_tmp
      fi

      echo "" >> .changelog_tmp

      # Prepend to CHANGELOG.md
      if [ -f CHANGELOG.md ]; then
        cat CHANGELOG.md >> .changelog_tmp
        mv .changelog_tmp CHANGELOG.md
      else
        mv .changelog_tmp CHANGELOG.md
      fi

  # Stage 4: Build and validation
  - id: build-package
    name: Build Python package
    type: shell
    depends_on: [update-version, lint-check]
    command: |
      cd "${repo}" && \
      rm -rf dist/ build/ *.egg-info && \
      python -m build
    output_var: build_output

  - id: validate-package
    name: Validate built package
    type: shell
    depends_on: build-package
    command: |
      cd "${repo}" && \
      python -m twine check dist/*

  - id: test-installation
    name: Test package installation
    type: shell
    depends_on: validate-package
    command: |
      # Create temporary venv
      temp_venv=$(mktemp -d)
      python -m venv "$temp_venv"

      # Install and test
      "$temp_venv/bin/pip" install "${repo}"/dist/*.whl
      "$temp_venv/bin/python" -c "import ${repo_name}; print('Package imported successfully')"

      # Cleanup
      rm -rf "$temp_venv"

  # Stage 5: Git operations
  - id: commit-changes
    name: Commit version changes
    type: shell
    depends_on: [update-changelog, test-installation]
    command: |
      cd "${repo}" && \
      git add -A && \
      git commit -m "Release version ${version}

      - Updated version numbers
      - Updated CHANGELOG.md
      - Prepared for PyPI release"

  - id: create-tag
    name: Create release tag
    type: shell
    depends_on: commit-changes
    command: |
      cd "${repo}" && \
      git tag -a "v${version}" -m "Release version ${version}"

  - id: push-changes
    name: Push to remote
    type: shell
    depends_on: create-tag
    command: |
      cd "${repo}" && \
      git push origin ${branch} && \
      git push origin "v${version}"

  # Stage 6: GitHub release
  - id: create-github-release
    name: Create GitHub release
    type: shell
    depends_on: push-changes
    command: |
      cd "${repo}" && \
      gh release create "v${version}" \
        --title "Release ${version}" \
        --notes-file CHANGELOG.md \
        --target ${branch} \
        dist/*

  # Stage 7: PyPI deployment
  - id: upload-test-pypi
    name: Upload to TestPyPI
    type: shell
    depends_on: create-github-release
    condition: "${DEPLOY_TEST_PYPI}" == "true"
    command: |
      cd "${repo}" && \
      python -m twine upload --repository testpypi dist/*
    ignore_errors: true

  - id: upload-pypi
    name: Upload to PyPI
    type: shell
    depends_on: create-github-release
    command: |
      cd "${repo}" && \
      python -m twine upload dist/*
    on_failure: stop

  # Stage 8: Post-release
  - id: verify-pypi
    name: Verify PyPI availability
    type: shell
    depends_on: upload-pypi
    command: |
      sleep 30  # Give PyPI time to update
      pip install --no-cache-dir "${repo_name}==${version}"
      python -c "import ${repo_name}; assert ${repo_name}.__version__ == '${version}'"

  - id: update-docs
    name: Update documentation
    type: ghops
    depends_on: verify-pypi
    command: docs build
    args: ["${repo}", "--deploy"]
    ignore_errors: true

  - id: announce-release
    name: Announce release on social media
    type: ghops
    depends_on: verify-pypi
    command: social post
    args: |
      --message "Released ${repo_name} v${version}! Check out the latest features and improvements.

      Install: pip install ${repo_name}==${version}
      Release notes: https://github.com/${GITHUB_USER}/${repo_name}/releases/tag/v${version}

      #opensource #python #release"
    ignore_errors: true

  # Final summary
  - id: generate-summary
    name: Generate release summary
    type: python
    depends_on: [verify-pypi, update-docs, announce-release]
    code: |
      print("=" * 60)
      print(f"RELEASE SUCCESSFUL: {context['repo_name']} v{context['version']}")
      print("=" * 60)
      print(f"- Test coverage: {context.get('test_coverage', 'N/A')}%")
      print(f"- GitHub release: https://github.com/{os.environ.get('GITHUB_USER')}/{context['repo_name']}/releases/tag/v{context['version']}")
      print(f"- PyPI: https://pypi.org/project/{context['repo_name']}/{context['version']}/")
      print("=" * 60)

# Workflow hooks
hooks:
  on_start:
    - type: shell
      command: |
        echo "Starting release pipeline for ${repo_path} version ${version}"
        echo "Release type: ${release_type}"

  on_success:
    - type: shell
      command: |
        echo "Release completed successfully!"
        # Send success notification
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"Successfully released ${repo_name} v${version}\"}"
        fi

  on_failure:
    - type: shell
      command: |
        echo "Release failed! Check logs for details"
        # Rollback tag if it was created
        cd "${repo}" && git tag -d "v${version}" 2>/dev/null || true